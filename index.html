<script>
    // ==================== KONFIGURASI ====================
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzC76BMRy2fehSZaEcnun7kKUry06XCyeQ0lizEMM4g0mAvdTsTPpAhSSZXjs4661Cc/exec";
    const CORRECT_PASSWORD = "arakuganteng";
    let isLoggedIn = false;
    let isEditMode = false;
    let galleryImages = [];

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('Araku Profile dimulai...');
        
        // Cek login
        if (localStorage.getItem('araku_profile_logged_in') === 'true') {
            isLoggedIn = true;
            enableEditMode();
            document.getElementById('mainAdminBtn').textContent = "üîì EDIT MODE ON";
        }
        
        // Load data lokal dulu
        loadLocalData();
        
        // Coba load dari server
        try {
            await loadServerData();
        } catch (e) {
            console.log('Gagal load server:', e.message);
        }
        
        setupEventListeners();
    });

    // ==================== SIMPLE UPLOAD SYSTEM ====================
    // Sistem sederhana: Simpan di localStorage, sync ke server jika bisa
    
    async function handleImageUpload(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validasi
        if (file.size > 500 * 1024) { // 500KB max untuk server
            showStatus('Max 500KB untuk upload ke server', 'warning');
        }
        
        if (!file.type.startsWith('image/')) {
            showStatus('Hanya file gambar!', 'error');
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            const imageData = e.target.result;
            
            // Update UI langsung
            if (type === 'avatar') {
                document.getElementById('avatarImg').src = imageData;
                localStorage.setItem('araku_profile_avatar', imageData);
            } else if (type === 'about') {
                document.getElementById('aboutImg').src = imageData;
                localStorage.setItem('araku_profile_about', imageData);
            } else if (type === 'gallery') {
                galleryImages.push({
                    src: imageData,
                    alt: file.name || `Karya ${galleryImages.length + 1}`
                });
                localStorage.setItem('araku_profile_gallery', JSON.stringify(galleryImages));
                renderGallery();
            }
            
            // Coba save ke server (tidak blocking)
            try {
                await saveToServer(type, imageData, file.name);
                showStatus('Gambar disimpan ‚úì', 'success');
            } catch (error) {
                showStatus('Disimpan lokal saja', 'warning');
            }
        };
        
        reader.readAsDataURL(file);
        event.target.value = '';
    }

    async function saveToServer(type, imageData, fileName) {
        // Potong data jika terlalu besar untuk URL
        let dataToSend = imageData;
        if (imageData.length > 100000) { // ~100KB max
            dataToSend = imageData.substring(0, 100000);
        }
        
        // Gunakan FormData untuk POST
        const formData = new FormData();
        formData.append('action', 'upload_image');
        formData.append('type', type);
        formData.append('image_data', dataToSend);
        formData.append('file_name', fileName || type);
        
        // Kirim dengan no-cors (tidak bisa baca response)
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: formData
        });
        
        console.log('Upload attempted to server');
    }

    async function loadServerData() {
        try {
            const url = APPS_SCRIPT_URL + '?action=get_data&_=' + Date.now();
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success && result.data) {
                mergeServerData(result.data);
            }
        } catch (error) {
            throw error;
        }
    }

    function mergeServerData(serverData) {
        // Gabungkan data server dengan lokal
        if (serverData.avatar && serverData.avatar.startsWith('data:image')) {
            localStorage.setItem('araku_profile_avatar', serverData.avatar);
            document.getElementById('avatarImg').src = serverData.avatar;
        }
        
        if (serverData.about && serverData.about.startsWith('data:image')) {
            localStorage.setItem('araku_profile_about', serverData.about);
            document.getElementById('aboutImg').src = serverData.about;
        }
        
        if (serverData.gallery && Array.isArray(serverData.gallery)) {
            const localGallery = JSON.parse(localStorage.getItem('araku_profile_gallery') || '[]');
            
            // Filter hanya gambar dari server yang valid
            const serverImages = serverData.gallery.filter(img => 
                img.src && img.src.startsWith('data:image')
            );
            
            // Gabungkan, hilangkan duplikat
            const combined = [...localGallery];
            serverImages.forEach(serverImg => {
                if (!combined.some(localImg => localImg.src === serverImg.src)) {
                    combined.push(serverImg);
                }
            });
            
            galleryImages = combined;
            localStorage.setItem('araku_profile_gallery', JSON.stringify(combined));
            renderGallery();
        }
        
        console.log('Data server dimerge');
    }

    // ==================== BASIC FUNCTIONS ====================
    function loadLocalData() {
        // Load texts
        const elements = {
            'name': 'nameText',
            'tagline': 'taglineText',
            'aboutText': 'aboutText',
            // ... tambahkan lainnya sesuai kebutuhan
        };
        
        Object.keys(elements).forEach(id => {
            const saved = localStorage.getItem('araku_profile_' + id);
            if (saved) {
                const el = document.getElementById(elements[id]);
                if (el) el.textContent = saved;
            }
        });
        
        // Load images
        const avatar = localStorage.getItem('araku_profile_avatar');
        const about = localStorage.getItem('araku_profile_about');
        const gallery = localStorage.getItem('araku_profile_gallery');
        
        if (avatar) {
            document.getElementById('avatarImg').src = avatar;
        } else {
            document.getElementById('avatarImg').src = 'https://placehold.co/120x120/2d3436/ffffff?text=AKU';
        }
        
        if (about) {
            document.getElementById('aboutImg').src = about;
        } else {
            document.getElementById('aboutImg').src = 'https://placehold.co/270x290/74b9ff/ffffff?text=ABOUT';
        }
        
        if (gallery) {
            try {
                galleryImages = JSON.parse(gallery);
                renderGallery();
            } catch (e) {
                galleryImages = [];
            }
        }
    }

    function renderGallery() {
        const container = document.getElementById('galleryContainer');
        
        if (!galleryImages.length) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:#666; grid-column:1/-1">
                    üñºÔ∏è<br>
                    <p style="font-size:0.5em; margin-top:10px">Belum ada gambar</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        galleryImages.forEach((img, index) => {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.onclick = () => {
                document.getElementById('modalImage').src = img.src;
                document.getElementById('galleryModal').classList.add('active');
            };
            
            const imgEl = document.createElement('img');
            imgEl.src = img.src;
            imgEl.alt = img.alt || `Karya ${index + 1}`;
            
            if (isEditMode) {
                const delBtn = document.createElement('button');
                delBtn.className = 'upload-btn';
                delBtn.textContent = 'X';
                delBtn.style.cssText = 'position:absolute; top:5px; left:5px; z-index:10; padding:3px 6px; font-size:0.25em';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm('Hapus?')) {
                        galleryImages.splice(index, 1);
                        localStorage.setItem('araku_profile_gallery', JSON.stringify(galleryImages));
                        renderGallery();
                    }
                };
                item.appendChild(delBtn);
            }
            
            item.appendChild(imgEl);
            container.appendChild(item);
        });
    }

    // ==================== UI FUNCTIONS ====================
    function showStatus(msg, type = 'info') {
        const el = document.getElementById('statusMessage');
        el.textContent = msg;
        el.style.backgroundColor = 
            type === 'success' ? '#2ecc71' :
            type === 'error' ? '#e74c3c' :
            type === 'warning' ? '#f39c12' : '#3498db';
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
    }

    function setupEventListeners() {
        // File inputs
        document.getElementById('avatarUpload').onchange = (e) => handleImageUpload(e, 'avatar');
        document.getElementById('aboutUpload').onchange = (e) => handleImageUpload(e, 'about');
        document.getElementById('galleryUpload').onchange = (e) => {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    galleryImages.push({
                        src: e.target.result,
                        alt: file.name
                    });
                    localStorage.setItem('araku_profile_gallery', JSON.stringify(galleryImages));
                    renderGallery();
                };
                reader.readAsDataURL(file);
            });
        };
        
        // Login
        document.getElementById('passwordInput').onkeypress = (e) => {
            if (e.key === 'Enter') checkLogin();
        };
        
        // Modal close
        document.querySelector('.close-modal').onclick = () => {
            document.getElementById('galleryModal').classList.remove('active');
        };
    }

    function checkLogin() {
        const input = document.getElementById('passwordInput');
        const error = document.getElementById('loginError');
        
        if (input.value === CORRECT_PASSWORD) {
            isLoggedIn = true;
            localStorage.setItem('araku_profile_logged_in', 'true');
            enableEditMode();
            hideLogin();
            document.getElementById('mainAdminBtn').textContent = "üîì EDIT MODE ON";
            showStatus('Login berhasil!', 'success');
        } else {
            error.textContent = "Password salah!";
            input.value = "";
            input.focus();
        }
    }

    function enableEditMode() {
        // Add upload buttons
        const avatarBtn = document.createElement('button');
        avatarBtn.className = 'upload-btn';
        avatarBtn.textContent = 'üì∑ Ganti';
        avatarBtn.style.cssText = 'position:absolute; bottom:5px; left:50%; transform:translateX(-50%); z-index:10';
        avatarBtn.onclick = () => document.getElementById('avatarUpload').click();
        document.querySelector('.avatar').appendChild(avatarBtn);
        
        const aboutBtn = document.createElement('button');
        aboutBtn.className = 'upload-btn';
        aboutBtn.textContent = 'üì∑ Ganti';
        aboutBtn.style.cssText = 'position:absolute; bottom:5px; left:50%; transform:translateX(-50%); z-index:10';
        aboutBtn.onclick = () => document.getElementById('aboutUpload').click();
        document.querySelector('.about-photo').appendChild(aboutBtn);
        
        // Enable text editing
        document.body.classList.add('edit-mode');
    }

    function hideLogin() {
        document.getElementById('loginOverlay').classList.remove('active');
        document.getElementById('loginPanel').classList.remove('active');
        document.getElementById('passwordInput').value = '';
        document.getElementById('loginError').textContent = '';
    }

    // ==================== ADMIN BUTTON ====================
    document.getElementById('mainAdminBtn').onclick = function() {
        if (isLoggedIn) {
            // Toggle edit mode
            isEditMode = !isEditMode;
            document.body.classList.toggle('edit-mode', isEditMode);
            this.textContent = isEditMode ? "üíæ EDIT MODE ON" : "üîì EDIT MODE OFF";
            renderGallery();
        } else {
            // Show login
            document.getElementById('loginOverlay').classList.add('active');
            document.getElementById('loginPanel').classList.add('active');
            document.getElementById('passwordInput').focus();
        }
    };
    
    // Double click logout
    let clicks = 0;
    document.getElementById('mainAdminBtn').addEventListener('click', function() {
        clicks++;
        if (clicks === 2 && isLoggedIn) {
            if (confirm('Logout?')) {
                isLoggedIn = isEditMode = false;
                localStorage.removeItem('araku_profile_logged_in');
                document.body.classList.remove('edit-mode');
                this.textContent = "üîê EDIT PROFILE";
                document.querySelectorAll('.upload-btn').forEach(btn => btn.remove());
                renderGallery();
            }
        }
        setTimeout(() => clicks = 0, 300);
    });
</script>
